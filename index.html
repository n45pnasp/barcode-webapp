<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scanner & Parser Barcode Boarding Pass</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f7fa;
      margin: 0; padding: 1.5em;
      color: #333;
      display: flex; justify-content: center;
      min-height: 100vh;
    }
    .container {
      max-width: 720px;
      width: 100%;
      background: white;
      padding: 1.5em 2em;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 1rem;
    }
    #reader {
      width: 100%;
      min-height: 300px;
      margin-bottom: 1em;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 8px rgba(0,0,0,0.15);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
      font-size: 0.95rem;
      white-space: nowrap;
    }
    th {
      background-color: #007bff;
      color: white;
      font-weight: 600;
    }
    tr:hover td {
      background-color: #f1f8ff;
    }
    #log {
      font-family: monospace;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1em;
      min-height: 1.5em;
      text-align: center;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Scanner & Parser Barcode Boarding Pass</h1>

  <div id="reader"></div>

  <div id="log">Meminta izin kamera...</div>

  <div id="result"></div>
</div>

<!-- html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<script>
  const resultContainer = document.getElementById('result');
  const log = document.getElementById('log');
  const readerElementId = "reader";

  let html5QrcodeScanner;
  let scanning = false;

  function julianToDate(julian) {
    const now = new Date();
    const year = now.getFullYear();
    const start = new Date(year, 0, 1);
    const date = new Date(start.getTime() + (julian - 1) * 24 * 60 * 60 * 1000);
    return date.toISOString().slice(0, 10);
  }

  function parseLine(line) {
    if (!line.trim()) return null;
    const parts = line.trim().split(/\s+/);
    if (parts.length < 5) return null;

    const seat = parts.pop();
    const flightInfo = parts.pop();

    const flightNumberRaw = flightInfo.slice(3, 8);
    const julianDay = parseInt(flightInfo.slice(0, 3), 10);
    const date = julianToDate(julianDay);

    const routeRaw = parts.pop();
    const routeClean = routeRaw.slice(0, -2);
    const maskapaiCode = routeRaw.slice(-2);

    const maskapaiMap = {
      'UI': 'SUPER AIR JET',
      'ID': 'BATIK AIR',
    };

    const maskapai = maskapaiMap[maskapaiCode] || 'UNKNOWN';

    let route;
    if (routeClean.length === 6) {
      route = routeClean.slice(0, 3) + ' â†’ ' + routeClean.slice(3, 6);
    } else {
      route = routeClean;
    }

    parts.pop(); // discard booking code

    const nameStr = parts.join(' ');
    const nameParts = nameStr.split('/');
    if (nameParts.length < 2) return null;

    const lastNameRaw = nameParts[0].replace(/^M1/, '').trim();
    const frontPartRaw = nameParts[1].trim();

    // Pisahkan nama depan dan gelar jika ada
    const frontSplit = frontPartRaw.split(' ');
    let firstName = frontSplit[0];
    let title = '';
    if (frontSplit.length > 1) {
      title = frontSplit.slice(1).join(' ');
    }

    // Gabungkan nama sesuai format: [title + spasi] firstName lastName
    const fullName = title ? `${firstName} ${title} ${lastNameRaw}` : `${firstName} ${lastNameRaw}`;

    return {
      Nama: fullName,
      Tanggal: date,
      Route: route,
      Maskapai: maskapai,
      Seat: flightNumberRaw,
    };
  }

  function displayResult(data) {
    if (!data) {
      resultContainer.innerHTML = '<p style="color: #d33;">Data barcode tidak valid.</p>';
      return;
    }
    const html = `
      <table>
        <thead>
          <tr>
            <th>Nama</th>
            <th>Tanggal</th>
            <th>Route</th>
            <th>Maskapai</th>
            <th>Seat</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>${data.Nama}</td>
            <td>${data.Tanggal}</td>
            <td>${data.Route}</td>
            <td>${data.Maskapai}</td>
            <td>${data.Seat}</td>
          </tr>
        </tbody>
      </table>`;
    resultContainer.innerHTML = html;
  }

  function onScanSuccess(decodedText, decodedResult) {
    if (!scanning) return;
    log.textContent = 'Data barcode terbaca, parsing...';
    scanning = false;

    html5QrcodeScanner.stop().then(() => {
      log.textContent = 'Scan berhenti.';
      displayResult(parseLine(decodedText));
    }).catch(err => {
      log.textContent = 'Gagal berhenti scan: ' + err;
    });
  }

  function onScanFailure(error) {
    // optional, jangan terlalu sering tampilkan log
  }

  function startScanning() {
    html5QrcodeScanner = new Html5Qrcode(readerElementId);

    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        scanning = true;
        const cameraId = cameras[0].id;
        log.textContent = 'Menyala, arahkan kamera ke barcode boarding pass...';
        html5QrcodeScanner.start(
          cameraId,
          {
            fps: 10,
            qrbox: 250
          },
          onScanSuccess,
          onScanFailure
        ).catch(err => {
          log.textContent = 'Gagal mulai scan: ' + err;
        });
      } else {
        log.textContent = 'Tidak ditemukan kamera pada perangkat.';
      }
    }).catch(err => {
      log.textContent = 'Gagal akses kamera: ' + err;
    });
  }

  // Minta izin kamera lalu mulai scanning otomatis
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(() => {
      startScanning();
    })
    .catch(() => {
      log.textContent = 'Izin kamera ditolak atau kamera tidak tersedia.';
    });
</script>

</body>
</html>
